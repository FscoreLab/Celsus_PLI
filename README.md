# CT-CLIP Inference API

## ğŸ“‹ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ

**CT-CLIP Inference API** â€” ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° ĞºĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€Ğ½Ñ‹Ñ… Ñ‚Ğ¾Ğ¼Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼ (ĞšĞ¢) Ğ³Ñ€ÑƒĞ´Ğ½Ğ¾Ğ¹ ĞºĞ»ĞµÑ‚ĞºĞ¸. Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ REST API Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ DICOM-Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ¾Ğ² Ğ¸ Ğ²Ñ‹ÑĞ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ‚Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¹ Ğ¸ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¹.

### ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ° Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ğ²Ñ€Ğ°Ñ‡ĞµĞ¹-Ñ€ĞµĞ½Ñ‚Ğ³ĞµĞ½Ğ¾Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğµ ĞšĞ¢-Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹. API Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ ZIP-Ğ°Ñ€Ñ…Ğ¸Ğ² Ñ DICOM Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ²ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸ Ğ¿Ğ°Ñ‚Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸ Ğ² Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸, Ğ° Ñ‚Ğ°ĞºĞ¶Ğµ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ.

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ°Ğ½ÑĞ°Ğ¼Ğ±Ğ»ÑŒ Ğ¸Ğ· Ñ‚Ñ€Ñ‘Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ:

1. **CT-CLIP Model** â€” Ğ¿Ñ€ĞµĞ´Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Vision Transformer (https://arxiv.org/abs/2403.17834)
2. **Supervised Model** â€” ÑĞ½ĞºĞ¾Ğ´ĞµÑ€ CT-CLIP, Ğ´Ğ¾Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ½Ğ° Ñ€Ğ°Ğ·Ğ¼ĞµÑ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ¿Ğ°Ñ‚Ğ¾Ğ»Ğ¾Ğ³Ğ¸ÑĞ¼Ğ¸
3. **Anomaly Diffusion Detector** - Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ğ¸ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ´Ğ¸Ñ„Ñ„ÑƒĞ·Ğ¸Ğ¸

ĞŸÑ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑÑÑ‚ÑÑ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ **LightGBM** Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ³Ñ€Ğ°Ğ´Ğ¸ĞµĞ½Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ±ÑƒÑÑ‚Ğ¸Ğ½Ğ³Ğ°

---

## âœ¨ ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸

- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ€Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²ĞºĞ° Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ZIP-Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ¾Ğ² Ñ DICOM-Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸
- Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑĞµÑ€Ğ¸Ğ¸
- Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ²ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ¿Ğ°Ñ‚Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸, Ğ° Ñ‚Ğ°ĞºĞ¶Ğµ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ²ĞµÑ€Ğ¾ÑÑ‚Ğ½ÑƒÑ Ğ¿Ğ°Ñ‚Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ 

---

## ğŸ’» Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

- **ĞĞ¡**: Linux (Ubuntu 20.04+)
- **Docker**: Docker >= 20.10
- **Docker Compose**: >= 1.29
- **Ğ”Ğ¸ÑĞº**: 50 GB
- **RAM**: 32 GB
- **GPU**: Nvidia, Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ 12GB vRAM
- 
---

## ğŸš€ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ (Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ)

### 1. Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑĞ¼Ğ¸
Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ
```bash
docker compose pull 
```

### 2. Ğ—Ğ°Ğ¿ÑƒÑĞº

```bash
docker-compose build
docker-compose up -d
```

### 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°

```bash
curl http://localhost:8000/health
```

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚:**
```json
{
  "status": "healthy"
}
```

### 4. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

```bash
zip -r test_study.zip /path/to/dicom/files/

curl -X POST "http://localhost:8000/predict" \
  -F "file=@test_study.zip" \
  -o result.json

cat result.json | jq .
```

## ğŸš€ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ (Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ)

### 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°

```bash
curl http://93.187.188.50:7654/health
```

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚:**
```json
{
  "status": "healthy"
}
```

### 2. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

```bash
zip -r test_study.zip /path/to/dicom/files/

curl -X POST "http://93.187.188.50:7654/predict" \
  -F "file=@test_study.zip" \
  -o result.json

cat result.json | jq .
```


---

## ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
Celsus_PLI/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ __init__.py                  # Python Ğ¿Ğ°ĞºĞµÑ‚ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
â”‚   â”œâ”€â”€ main.py                      # FastAPI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
â”‚   â”œâ”€â”€ inference_service.py         # Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¸Ğ½Ñ„ĞµÑ€ĞµĞ½ÑĞ° Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹
â”‚   â”œâ”€â”€ requirements.txt             # Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
â”‚   â”œâ”€â”€ Dockerfile                   # Docker Ğ¾Ğ±Ñ€Ğ°Ğ·
â”‚   â”œâ”€â”€ docker-compose.yml           # Docker Compose ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
â”‚   â”œâ”€â”€ batch_inference_client.py    # ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¿Ğ°ĞºĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
â”‚   â”œâ”€â”€ prepare_and_run_inference.py # Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ¸ DICOM Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ¾Ğ²
â”‚   â””â”€â”€ run_api.sh                   # Bash ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° API
â”‚
â”œâ”€â”€ best_models/                     # ĞŸÑ€ĞµĞ´Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
â”‚   â”œâ”€â”€ CT_VocabFine_v2.pt          # CT-CLIP Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
â”‚   â”œâ”€â”€ diffusion_checkpoint_step_4000.pt  # Diffusion Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
â”‚   â””â”€â”€ supervised_model.pt          # Supervised Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
â”‚
â”œâ”€â”€ CT_CLIP/                         # CT-CLIP Ğ¿Ğ°ĞºĞµÑ‚
â”‚   â””â”€â”€ ct_clip/                     # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ
â”‚       â”œâ”€â”€ ct_clip.py               # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
â”‚       â”œâ”€â”€ distributed.py           # Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ğ¾Ğµ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ
â”‚       â”œâ”€â”€ mlm.py                   # Masked Language Modeling
â”‚       â”œâ”€â”€ tokenizer.py             # Ğ¢Ğ¾ĞºĞµĞ½Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€
â”‚       â””â”€â”€ visual_ssl.py            # Visual SSL
â”‚
â”œâ”€â”€ diffusion_anomaly/               # Diffusion anomaly detection
â”‚   â”œâ”€â”€ gaussian_diffusion.py        # Gaussian diffusion Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ
â”‚   â”œâ”€â”€ unet.py                      # U-Net Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°
â”‚   â”œâ”€â”€ script_util.py               # Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
â”‚   â””â”€â”€ ...                          # Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸ diffusion
â”‚
â”œâ”€â”€ transformer_maskgit/             # Transformer MaskGIT
â”‚   â””â”€â”€ transformer_maskgit/
â”‚       â”œâ”€â”€ attention.py             # Attention Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼
â”‚       â””â”€â”€ ctvit.py                 # CT Vision Transformer
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ universal_ct_inference.py    # Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ ÑĞºÑ€Ğ¸Ğ¿Ñ‚
â”‚
â”œâ”€â”€ ct_clip_classifier.py            # CT-CLIP ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€
â”œâ”€â”€ README.md                        # Ğ­Ñ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ»
â”œâ”€â”€ DEPLOYMENT_GUIDE.md              # Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
â””â”€â”€ USER_GUIDE.md                    # Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
```

---

## ğŸ”Œ API Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹

### `GET /health` â€” Health Check

```bash
curl http://localhost:8000/health
```

**ĞÑ‚Ğ²ĞµÑ‚:**
```json
{
  "status": "healthy"
}
```

### `POST /predict` â€” Ğ˜Ğ½Ñ„ĞµÑ€ĞµĞ½Ñ Ğ½Ğ° DICOM Ğ°Ñ€Ñ…Ğ¸Ğ²Ğµ

```bash
curl -X POST "http://localhost:8000/predict" \
  -F "file=@/path/to/dicom_archive.zip"
```

**Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (Success):**
```json
{
  "study_uid": "1.2.840.113619.2.xxx",
  "series_uid": "1.2.840.113619.2.yyy",
  "probability_of_pathology": 0.87,
  "pathology": 1,
  "most_dangerous_pathology_type": "Pneumonia",
  "processing_status": "Success",
  "time_of_processing": 45.67,
}
```

**Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (Failure):**
```json
{
  "study_uid": "",
  "series_uid": "",
  "probability_of_pathology": null,
  "pathology": null,
  "most_dangerous_pathology_type": null,
  "processing_status": "Failure",
  "time_of_processing": 12.34,
  "error": "ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸"
}
```

---

## ğŸ“Š ĞŸĞ°ĞºĞµÑ‚Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°

```bash
python api/batch_inference_client.py \
  --input-dir /path/to/archives/ \
  --output results.xlsx \
  --api-url http://localhost:8000
```

---