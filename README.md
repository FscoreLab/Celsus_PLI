# CT-CLIP Inference API

## üìã –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è

**CT-CLIP Inference API** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö —Ç–æ–º–æ–≥—Ä–∞–º–º (–ö–¢) –≥—Ä—É–¥–Ω–æ–π –∫–ª–µ—Ç–∫–∏. –†–µ—à–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç REST API –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ DICOM-–∞—Ä—Ö–∏–≤–æ–≤ –∏ –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–∞—Ç–æ–ª–æ–≥–∏–π –∏ –∞–Ω–æ–º–∞–ª–∏–π.

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤—Ä–∞—á–µ–π-—Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥–æ–≤ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ö–¢-–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π. API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç ZIP-–∞—Ä—Ö–∏–≤ —Å DICOM —Ñ–∞–π–ª–∞–º–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–∞–ª–∏—á–∏ –ø–∞—Ç–æ–ª–æ–≥–∏–∏ –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏, –∞ —Ç–∞–∫–∂–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω—Å–∞–º–±–ª—å –∏–∑ —Ç—Ä—ë—Ö –º–æ–¥–µ–ª–µ–π –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è:

1. **CT-CLIP Model** ‚Äî –ø—Ä–µ–¥–æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ Vision Transformer (https://arxiv.org/abs/2403.17834)
2. **Supervised Model** ‚Äî —ç–Ω–∫–æ–¥–µ—Ä CT-CLIP, –¥–æ–æ–±—É—á–µ–Ω–Ω—ã–π –Ω–∞ —Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –ø–∞—Ç–æ–ª–æ–≥–∏—è–º–∏
3. **Anomaly Diffusion Detector** - –º–æ–¥–µ–ª—å –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏—Ñ—Ñ—É–∑–∏–∏

–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ **LightGBM** –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–≥–æ –±—É—Å—Ç–∏–Ω–≥–∞

---

## ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ ZIP-–∞—Ä—Ö–∏–≤–æ–≤ —Å DICOM-–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º–∏
- –ë–∞–∑–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –≤—ã–±–æ—Ä–∞ —Å–µ—Ä–∏–∏
- –°–∏—Å—Ç–µ–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–∞–ª–∏—á–∏—è –ø–∞—Ç–æ–ª–æ–≥–∏–∏, –∞ —Ç–∞–∫–∂–µ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—É—é –ø–∞—Ç–æ–ª–æ–≥–∏—é 

---

## üíª –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **–û–°**: Linux (Ubuntu 20.04+)
- **Docker**: Docker >= 20.10
- **Docker Compose**: >= 1.29
- **–î–∏—Å–∫**: 50 GB
- **RAM**: 32 GB
- **GPU**: Nvidia, –Ω–µ –º–µ–Ω–µ–µ 12GB vRAM
- 
---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ)

### 1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –º–æ–¥–µ–ª—è–º–∏
–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É
```bash
docker compose pull 
```

### 2. –ó–∞–ø—É—Å–∫

```bash
docker-compose build
docker-compose up -d
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
curl http://localhost:8000/health
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "status": "healthy"
}
```

### 4. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```bash
zip -r test_study.zip /path/to/dicom/files/

curl -X POST "http://localhost:8000/predict" \
  -F "file=@test_study.zip" \
  -o result.json

cat result.json | jq .
```

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–æ–±–ª–∞—á–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ)

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
curl http://93.187.188.50:7654/health
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "status": "healthy"
}
```

### 2. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```bash
zip -r test_study.zip /path/to/dicom/files/

curl -X POST "http://93.187.188.50:7654/predict" \
  -F "file=@test_study.zip" \
  -o result.json

cat result.json | jq .
```


---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Celsus_PLI/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                  # Python –ø–∞–∫–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ main.py                      # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ inference_service.py         # –õ–æ–≥–∏–∫–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ –º–æ–¥–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt             # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile                   # Docker –æ–±—Ä–∞–∑
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml           # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ batch_inference_client.py    # –ö–ª–∏–µ–Ω—Ç –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ prepare_and_run_inference.py # –£—Ç–∏–ª–∏—Ç–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ DICOM –∞—Ä—Ö–∏–≤–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ run_api.sh                   # Bash —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ API
‚îÇ
‚îú‚îÄ‚îÄ best_models/                     # –ü—Ä–µ–¥–æ–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ CT_VocabFine_v2.pt          # CT-CLIP –º–æ–¥–µ–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ diffusion_checkpoint_step_4000.pt  # Diffusion –º–æ–¥–µ–ª—å
‚îÇ   ‚îî‚îÄ‚îÄ supervised_model.pt          # Supervised –º–æ–¥–µ–ª—å
‚îÇ
‚îú‚îÄ‚îÄ CT_CLIP/                         # CT-CLIP –ø–∞–∫–µ—Ç
‚îÇ   ‚îî‚îÄ‚îÄ ct_clip/                     # –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å
‚îÇ       ‚îú‚îÄ‚îÄ ct_clip.py               # –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å
‚îÇ       ‚îú‚îÄ‚îÄ distributed.py           # –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
‚îÇ       ‚îú‚îÄ‚îÄ mlm.py                   # Masked Language Modeling
‚îÇ       ‚îú‚îÄ‚îÄ tokenizer.py             # –¢–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä
‚îÇ       ‚îî‚îÄ‚îÄ visual_ssl.py            # Visual SSL
‚îÇ
‚îú‚îÄ‚îÄ diffusion_anomaly/               # Diffusion anomaly detection
‚îÇ   ‚îú‚îÄ‚îÄ gaussian_diffusion.py        # Gaussian diffusion –ø—Ä–æ—Ü–µ—Å—Å
‚îÇ   ‚îú‚îÄ‚îÄ unet.py                      # U-Net –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ script_util.py               # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ ...                          # –î—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ diffusion
‚îÇ
‚îú‚îÄ‚îÄ transformer_maskgit/             # Transformer MaskGIT
‚îÇ   ‚îî‚îÄ‚îÄ transformer_maskgit/
‚îÇ       ‚îú‚îÄ‚îÄ attention.py             # Attention –º–µ—Ö–∞–Ω–∏–∑–º
‚îÇ       ‚îî‚îÄ‚îÄ ctvit.py                 # CT Vision Transformer
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ universal_ct_inference.py    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω—Ñ–µ—Ä–µ–Ω—Å —Å–∫—Ä–∏–ø—Ç
‚îÇ
‚îú‚îÄ‚îÄ ct_clip_classifier.py            # CT-CLIP –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä
‚îú‚îÄ‚îÄ README.md                        # –≠—Ç–æ—Ç —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ DEPLOYMENT_GUIDE.md              # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
‚îî‚îÄ‚îÄ USER_GUIDE.md                    # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

---

## üîå API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### `GET /health` ‚Äî Health Check

```bash
curl http://localhost:8000/health
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "healthy"
}
```

### `POST /predict` ‚Äî –ò–Ω—Ñ–µ—Ä–µ–Ω—Å –Ω–∞ DICOM –∞—Ä—Ö–∏–≤–µ

```bash
curl -X POST "http://localhost:8000/predict" \
  -F "file=@/path/to/dicom_archive.zip"
```

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (Success):**
```json
{
  "study_uid": "1.2.840.113619.2.xxx",
  "series_uid": "1.2.840.113619.2.yyy",
  "probability_of_pathology": 0.87,
  "pathology": 1,
  "most_dangerous_pathology_type": "Pneumonia",
  "processing_status": "Success",
  "time_of_processing": 45.67
}
```

**–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª–µ–π:**
- `study_uid` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (DICOM StudyInstanceUID)
- `series_uid` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Ä–∏–∏ (DICOM SeriesInstanceUID)
- `probability_of_pathology` ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–∞–ª–∏—á–∏—è –ø–∞—Ç–æ–ª–æ–≥–∏–∏ (0.0 - 1.0)
- `pathology` ‚Äî –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: 0 (–Ω–æ—Ä–º–∞) –∏–ª–∏ 1 (–ø–∞—Ç–æ–ª–æ–≥–∏—è)
- `most_dangerous_pathology_type` ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø–∞—Ç–æ–ª–æ–≥–∏—è, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–∏–±–æ–ª–µ–µ —Å–∏–ª—å–Ω–æ –ø–æ–≤–ª–∏—è–ª–∞ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –∏–ª–∏ `"No specific pathology detected"` –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ –≤—ã—è–≤–∏–ª–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–∞—Ç–æ–ª–æ–≥–∏–π
- `processing_status` ‚Äî —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏: "Success" –∏–ª–∏ "Failure"
- `time_of_processing` ‚Äî –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (Failure):**
```json
{
  "study_uid": "",
  "series_uid": "",
  "probability_of_pathology": null,
  "pathology": null,
  "most_dangerous_pathology_type": null,
  "processing_status": "Failure",
  "time_of_processing": 12.34,
  "error": "–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏"
}
```

---

## üìä –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

```bash
python api/batch_inference_client.py \
  --input-dir /path/to/archives/ \
  --output results.xlsx \
  --api-url http://localhost:8000
```

---